# Abstract

隨著 Byte-Addressable Memory Devices 的出現，分層記憶體的普及，page replacement 成為管理分層記憶體的既定方法。
儘管現有研究已展示了在頁面遷移方面的各種優化效果，但它未能解答一個根本性問題：基於頁面遷移的獨占記憶體分層策略——即頁面僅存在於快速記憶體或慢速記憶體之一，而非同時存在於兩者——是否是分層記憶體管理的最佳策略？ (主要就是說，有很多頁面遷移的優化演算法，但是否有更好的替代策略？獨占記憶體分層是否真的是記憶體分層管理的最佳選擇？
換句話說，這些研究關注的是如何改進現有策略的實現，而非反思這一策略本身是否合理。)

我們的研究顯示，基於頁面遷移的獨占記憶體分層在快速記憶體面臨壓力時會出現顯著的性能下降。
因此，此 paper 提出非獨占記憶體分層透過保留最近從慢速記憶體提升至快速記憶體的頁面副本，以緩解 memory thrashing 問題，因此開發了 NOMAD。
一種適用於 Linux 的新型頁面管理機制，具備交易式頁面遷移與頁面影子機制。他會將頁面遷移從程式執行的關鍵路徑中移除，並實現完全非同步的頁面遷移。

通過精心設計的微基準測試和實際應用評估顯示，NOMAD 在面對記憶體壓力時，能比現代化的 Linux 透明頁面放置（TPP）方法提升最多達 6 倍的性能。我們還將 NOMAD 與最近提出的基於硬體輔助和訪問採樣的頁面遷移方法進行了比較，並展示了 NOMAD 在各種場景中的優勢與潛在的弱點。

補充：
頁面遷移從程式執行的關鍵路徑中移除，並實現完全非同步的頁面遷移 的意思：
不要讓頁面遷移成為阻塞程式執行的操作。
例如，如果某個頁面需要從慢速記憶體移動到快速記憶體，而遷移完成之前程式被迫等待，這會導致執行延遲，降低性能。
非同步（Asynchronous）：指程式執行與頁面遷移是並行進行的，彼此獨立，互不阻塞。
實現非同步遷移意味著：
程式在讀取或寫入數據時，不需要等待頁面從一個記憶體層遷移到另一個記憶體層。
遷移過程由後台執行，程式執行只需訪問代理或緩存機制即可正常運作。

=============================================================================
# Introduction

分層記憶體管理的目標是充分利用每層記憶體的優勢，來優化整體數據訪問的延遲和頻寬。分層記憶體管理的核心是作業系統（OS）中的頁面管理，包括頁面的分配、放置和遷移。高效的頁面管理對於優化記憶體使用和性能，同時保持對用戶應用程式的透明性至關重要。

***傳統記憶體層次架構與新挑戰***  
頁面管理的唯一目標是將熱頁面保存在「性能」層（如 DRAM），並在需要時將冷頁面遷移（或驅逐）到「容量」層（如磁碟）。新記憶體技術在延遲和頻寬方面可以與 DRAM 的性能相媲美，範圍約為 DRAM 的 2-3 倍。因此，長期指導作業系統頁面管理設計的性能差距假設可能不再成立。如果頁面遷移的成本過高，將熱頁面提升到性能層可能不再有益。

不同於必須通過檔案系統作為塊設備訪問的磁碟，新的記憶體設備是字節可位址的，處理器可以通過普通的加載和存儲指令直接訪問。因此，對於容量層中的暖頁面，直接訪問頁面並避免遷移到性能層可能是更好的選擇。最重要的是，儘管分層記憶體的性能仍然具有層次結構，但硬體已不再具有層次性。Optane Persistent Memory 和 CXL Memory 對處理器來說都顯示為無 CPU 記憶體節點，作業系統可以將其用作普通的 DRAM。
(主要就是說，存取SSD的page可以像存取memory一樣的存取方式，就不用特別將SSD的page搬到memory)

***當前研究的局限性***  
現有的分層記憶體研究主要集中在加速記憶體層之間的頁面遷移。例如：
1. Nimble 使用透明大頁（Transparent Huge Pages, THP）、多執行緒頁面遷移和多頁面並行遷移來改進頁面遷移。
2. Transparent Page Placement (TPP) 擴展了 Linux 中現有的 NUMA 平衡機制，支持非同步頁面降級和同步頁面提升。
3. Memtis 和 TMTS 利用硬體性能計數器來減輕頁面訪問追蹤的開銷，並使用後台執行緒定期非同步地提升頁面。  

然而，這些方法存在兩個基本限制：  
1.  假設記憶體層之間是互斥的（Exclusive），熱頁面分配或遷移到性能層，而冷頁面降級到容量層，因此每個頁面僅存在於一個層中。當性能層的容量不足以容納熱數據時，獨占記憶體分層不可避免地導致過度的熱冷頁面交換或記憶體 thrashing。
2. 缺乏有效的頁面遷移機制來支持分層記憶體管理。頁面遷移的過程通常包括以下三步：
 * a.從頁表中取消映射頁面
 * b.將頁面內容複製到另一層
 * c.在頁表中重新映射頁面，指向新記憶體地址

頻繁的頁面遷移，例如由記憶體 thrashing 引起的遷移，可能使用戶感知的頻寬顯著降低（最多可降低 95%）。

***NOMAD 的創新點***  
本文提出了一種非獨占記憶體分層（Non-Exclusive Memory Tiering），允許性能層上的部分頁面在容量層上保留影子副本（Shadow Copy）。非獨占分層的優勢在於，在記憶體壓力下，如果頁面未被修改且其影子副本存在於容量層，頁面降級的成本僅需重新映射頁面，而無需進行頁面內容的複製，從而實現性能的平穩過渡。  
此外，為了降低頁面遷移的成本，特別是在頁面提升方面，本文提出了交易式頁面遷移（Transactional Page Migration, TPM），這是一種在遷移過程中仍允許訪問頁面的新機制。交易式遷移的主要特性包括：  
 * 在頁面內容複製到性能層的新頁面後，檢查頁面是否在遷移過程中被修改。如果頁面已被修改，則遷移（即交易）失效，並丟棄已複製的頁面；否則，將新的頁面映射到頁表中，舊頁面成為其影子副本。  

***實驗結果***  
NOMAD 框架集成了非獨占記憶體分層與交易式頁面遷移 ( TPM )，通過在 Linux 中的實作和多平台的測試，實驗結果表明：  
 * 在記憶體抖動的情況下，NOMAD 的性能比現代化的透明頁面放置（TPP）方法提高最多 6 倍。
 * 在 work set 大小適合性能層的情況下，NOMAD 的性能比 Memtis 高出最多 130%。  
 
NOMAD 展現了卓越的性能改善能力，同時驗證了其在記憶體管理上的創新實用性。


=============================================================================
# 2 Motivation and Related Work
我們介紹分層記憶體系統中的頁面管理背景，並以透明頁面放置系統 (Transparent Page Placement, TPP)【44】為例，這是一個為 CXL（Compute Express Link）支持的分層記憶體設計的最新頁面放置系統。本文利用 TPP 作為激勵性範例，重點說明當前頁面管理方法的主要局限性。  

### 2.1 Memory Tiering
***快取與分層的概念***  
快取 (Caching) 和分層 (Tiering) 是兩種傳統的軟體方法，用於管理由多種存儲媒介（如 CPU 快取、DRAM 和硬碟）組成的記憶體或存儲層次架構，其性能、容量和成本各異。以一般性來說，我們可以考慮兩層記憶體架構：  
1. 性能層（即快速層，Fast Tier）：由容量較小、速度較快但成本更高的存儲媒介支援。
2. 容量層（即慢速層，Slow Tier）：由容量較大、速度較慢但成本更低的存儲媒介構成。

***快取與分層的運作***  
 * 快取：數據存儲於容量層，頻繁訪問的「熱數據」會被策略性地複製到性能層。快取採用包含式頁面放置模式（Inclusive Page Placement），即僅在性能層中暫時存儲數據的副本。
 * 分層：新數據優先分配到性能層，如果頻繁訪問，則保留在性能層；而較少訪問的數據則可能被降級到容量層。分層採用獨占模式（Exclusive Mode），主動在記憶體或存儲介質之間重新分配頁面。  

***新型存儲設備與挑戰***  
隨著高頻寬記憶體（High Bandwidth Memory, HBM）【4】、CXL-based 記憶體【1】、Persistent Memory (PM)【7】和快速字節可位址 NVMe SSD【31】的出現，存儲設備在速度、容量和成本之間的取捨差距逐漸縮小。例如：  
 * Intel Optane DC Persistent Memory 在記憶體匯流排中以 DIMM 包裝形式提供，允許程式透過 CPU 的加載與存儲指令直接訪問數據。其容量是 DRAM 的近 8 倍，性能約為 DRAM 的 2-3 倍（寫入延遲低至 80 ns，讀取延遲約為 170 ns）【56】。
 * Compute Express Link (CXL)，基於 PCIe 的開放標準互連技術，提供一種類似記憶體的字節可位址介面，能連接多種記憶體設備（如 DRAM、PM、GPU 和 smartNICs）【50】。

在作業系統記憶體管理的視角中，CXL 記憶體或 PM 表現為遠端且無 CPU 的記憶體節點，類似於多插槽的非一致性記憶體存取（NUMA）節點。

***當前系統的不足***  
目前最先進的分層記憶體系統（如 TPP【44】、Memtis【37】、Nimble【54】、AutoTiering【32】）採用獨占記憶體分層，將 CXL 記憶體視為本地 DRAM 的延伸。這種方式避免了數據冗餘，但需要在記憶體層之間移動數據以優化訪問性能，例如將熱數據提升到性能層。然而，當記憶體層間的性能差距縮小時，獨占分層是否是最佳策略仍需進一步探討，尤其是在考慮數據移動成本的情況下。

***TPP 的性能評估***  
為評估透明頁面放置 (TPP)【44】的性能，我們進行了一個基於 CXL 的分層記憶體系統的微基準測試，詳見圖 1 和第 4 節。測試條件包括：  
 * 系統配置：16 GB 快速記憶體（本地 DRAM）和 16 GB 慢速記憶體（遠端 CXL 記憶體）。
 * 工作集大小（Working Set Size, WSS）：調整為適合快速記憶體（例如 10 GB）及超出快速記憶體容量（例如 24 GB）。
 * 初始數據放置策略：
   * Frequency-opt：根據訪問頻率（熱度）的降序放置頁面。
   * Random：隨機分配頁面。

***主要觀察結果***
1. 頁面遷移的高成本：當 WSS 適合快速記憶體時，TPP 在穩定狀態下（已成功遷移所有熱頁面）比進行中的狀態（TPP in progress）實現高出一個數量級的頻寬。但若不進行遷移，性能仍持續優於進行中的狀態，說明頁面遷移的成本高於其帶來的效益。
2. 記憶體抖動：當 WSS 超出快速記憶體容量時，TPP 無法達到穩定狀態，進入記憶體抖動。
3. 遷移的重要性：當初始放置策略次優且 WSS 可容納於快速記憶體時，頁面遷移對於實現最佳性能至關重要（如 10 GB WSS 和隨機放置的測試結果所示）。

###  2.2 Page Management
本節深入探討 Linux 的頁面管理設計，並分析頁面遷移過程中的開銷。我們的討論集中於以下兩個方面：  
1. 如何有效追蹤記憶體訪問並識別熱頁面；
2. 頁面在記憶體層之間遷移的機制。

***Tracking memory access***   
記憶體訪問追蹤可通過軟體（由核心完成）和/或硬體支援實現。具體方法包括：  
1. 頁面錯誤追蹤：透過將選定頁面的頁表項（Page Table Entry, PTE）權限設置為不可訪問，觸發輕微（Minor）頁面錯誤來捕獲記憶體訪問。此方法能精確測量頁面的訪問時間和頻率，但每次訪問都需觸發頁面錯誤，對程式執行的關鍵路徑產生高額外開銷。
2. 頁表掃描：定期檢查所有頁表項的訪問位元，確定最近訪問的頁面。相比頁面錯誤追蹤，頁表掃描需要在掃描開銷與追蹤準確性之間進行平衡，依賴適當的掃描間隔【37】。

***Linux 的熱頁面追蹤機制***  
Linux 採用一種「延遲頁表掃描」機制來追蹤熱頁面，作為分層記憶體管理的基礎：  
 * 為每個記憶體節點維護兩個 LRU（最近最少使用）列表：一個存儲熱頁面（Active List），另一個存儲冷頁面（Inactive List）。
 * 頁面默認加入冷頁面列表，根據以下兩個標誌升級至熱頁面列表：  
   * PG_referenced：當檢查 PTE 的訪問位元設置時觸發。
   * PG_active：當 PG_referenced 連續兩次設置後觸發。

例如：  
 * 文件支持的頁面：其訪問由作業系統透過檔案系統接口（如 read() 和 write()）處理，訪問時更新標誌。
 * 匿名頁面（如 malloc 分配的應用程式記憶體）：訪問由 MMU 硬體直接處理，核心僅在記憶體回收時更新其標誌。

在記憶體壓力下，交換守護程式（kswapd）會掃描冷頁面列表及其 PTE，回收/交換未設置 PG_referenced 的頁面，同時升級熱頁面至熱頁面列表。此延遲掃描機制降低追蹤開銷，但削弱了追蹤的準確性。

***TPP 的頁面管理***  
透明頁面放置 (TPP)【44】結合**頁表掃描**與**頁面錯誤追蹤**來追蹤熱頁面並決定是否將其從慢速記憶體提升至快速記憶體：
 * 將所有慢速記憶體中的頁面設為不可訪問，當用戶訪問這些頁面時觸發輕微頁面錯誤。
 * 如果錯誤頁面在熱頁面列表中，則遷移該頁面至快速記憶體。
 * 當快速記憶體壓力過大時，`kswapd` 將冷頁面降級到慢速記憶體。

***硬體支持的記憶體追蹤***  
硬體支持可通過向 PTE 添加計數字段來記錄記憶體訪問次數【45】，但這增加了主流架構（如 x86）的設計複雜性。實際上，硬體輔助採樣（如 Intel 平台的處理器事件採樣，PEBS【24,37】）已被用於記錄硬體事件（如 LLC 缺失或存儲指令）並推斷頁面訪問。然而，這種方法具有以下局限性：  
1. 採樣頻率與分析準確性之間需謹慎平衡。
2. 採樣粒度較粗，可能無法捕捉所有熱頁面，限制了及時的頁面遷移決策。

***頁面遷移的複雜性***  
頁面在記憶體層間的遷移涉及以下步驟：  
1. 透過頁面錯誤陷入核心處理；
2. 鎖定遷移頁面的 PTE，防止其他操作；
3. 向每個處理器發送 TLB 刷新（透過跨處理器中斷，IPIs），清除過期的 PTE；
4. 複製頁面內容到新層；
5. 重新映射 PTE，指向新記憶體位置。

同步遷移（如 TPP 的頁面提升）由用戶訪問頁面時觸發，會阻塞程式執行直至遷移完成。而非同步遷移（如 TPP 的頁面降級）由 `kswapd` 處理，通常在程式執行的關鍵路徑之外進行。

***TPP 的性能分析***  
圖 2 顯示了 TPP 遷移頁面時的運行時間分解：  
 * 頁面提升為同步操作，與頁面錯誤處理共同執行，對應用程式核心產生顯著開銷。
 * 相比之下，頁面降級由 kswapd 處理，幾乎不造成瓶頸。

這種高開銷的同步遷移解釋了圖 1 中 TPP 性能下降的原因。此外，用戶空間執行時間可能因多次輕微頁面錯誤（最多 15 次才能成功提升一個頁面）而延長，進一步影響整體性能。

###  2.3 Related Work
***分層存儲/記憶體系統的研究歷程***  
先前的研究已探索了廣泛的分層存儲和記憶體系統，涵蓋以下範疇：  
 * SSD 與 HDD【12,15,22,26,33,41,49,52,57】
 * DRAM 與磁碟【21,25,29,46】
 * HBM（High Bandwidth Memory）與 DRAM【23,45,48】
 * NUMA 記憶體（非一致性記憶體存取）【2,3】
 * PM（Persistent Memory，非易失性記憶體）與 DRAM【13,14,40,43】
 * 本地與遠程記憶體【19,27,34,35,47】
 * DRAM 與 CXL 記憶體【37,38,44】
 * 多層次記憶體【32,36,40,51,54】

本研究重點探討 DRAM 與新興字節可位址記憶體設備（如 CXL 記憶體和 PM）的分層記憶體系統。NOMAD 同樣適用於其他分層記憶體系統，如 HBM/DRAM 和 DRAM/PM。

***輕量化記憶體訪問追蹤***  
為減輕記憶體訪問追蹤的軟體開銷，不同方法的設計如下：  
1. Hotbox【19】：使用兩個掃描器，對慢速層固定速率掃描，對快速層採用基於本地記憶體壓力的自適應速率掃描。
2. Memtis【37】：調整基於 PEBS（Processor Event-Based Sampling，處理器事件採樣）的採樣率，將開銷控制在 3% 以下。
3. TMTS【24】：結合定期掃描與硬體採樣，以更及時地檢測新熱頁面。
4. Thermostat【14】：僅採樣一小部分頁面以降低掃描開銷。
5. DAMON【3】：以更粗粒度（如區域）監測記憶體訪問，進一步減少掃描負擔。

這些方法在掃描/採樣開銷與準確性之間取得平衡，但並不適合高壓力工作負載中的「always-on」型分析。此外，像 AutoNUMA【2】這樣的頻繁提示頁面錯誤可能導致較高的開銷，而 TPP【44】則僅針對 CXL 記憶體使用頁面錯誤檢測，並透過同步遷移快速提升頁面，避免多次頁面錯誤。

***NOMAD 的改進***  
NOMAD 受到 Linux 熱/冷頁面列表和提示頁面錯誤的啟發，進一步優化追蹤系統，無需額外的 CPU 開銷，亦不同於硬體輔助方法【24,37,42】，因為其不依賴任何硬體支持。

***頁面遷移優化***  
不同方法對頁面遷移的處理如下：  
1. TPP【44】：解耦頁面分配與回收，但頁面遷移仍在程式執行的關鍵路徑中，造成明顯的性能下降。
2. Nimble【54】：引入透明大頁（Transparent Huge Page, THP）遷移和多頁面並行遷移等機制，減少頁面遷移開銷。
3. Memtis【37】：透過內核執行緒在後台促進/降級頁面，將遷移移出程式的關鍵路徑。
4. TMTS【24】：採用用戶/內核協作的方法來控制頁面遷移。

***NOMAD 的差異化優勢***  
NOMAD 專注於實現即時、按需的頁面遷移，並將遷移過程移出關鍵路徑。它與現有遷移優化方法是正交的，並能從中受益。例如，與【20】的硬體支持方法（通過將數據固定在快取中以支持遷移過程中的頁面訪問）相比，NOMAD 無需硬體支持，具有更高的適用性。





#  5 Discussions and Future Work
***NOMAD 的關鍵見解***  
根據 NOMAD 的評估，頁面遷移（特別是在記憶體壓力下）對應用程式整體性能產生了負面影響。雖然 NOMAD 在性能降級的平滑度和整體表現上顯著優於基於同步頁面遷移的 TPP，但其性能仍低於完全不進行頁面遷移的情況。

當程式的工作集大小 (Working Set Size, WSS) 超過快速層的容量時，最有效的策略是直接從頁面的初始位置訪問數據，完全禁用頁面遷移。檢測記憶體抖動（例如頁面降級和提升次數頻繁且相等）以禁用頁面遷移相對簡單。然而，當 WSS 跨越多層記憶體時，要估算工作集大小以重新啟用頁面遷移變得具有挑戰性。這需要全球記憶體追蹤（Global Memory Tracking）來識別可遷移到快速層的熱數據集，但這可能代價昂貴。  

***未來改進方向***  
我們計劃擴展 NOMAD：  
1. 單方面限制頁面提升的頻率；
2. 監控頁面降級以有效管理快速層的記憶體壓力。

這需要開發新的頁面遷移策略，與本文中提出的 NOMAD 遷移機制是正交的。

***平台特性的影響***  
頁面錯誤（Page Fault）追蹤方法（如 TPP 和 NOMAD）與基於硬體性能計數器的記憶體訪問採樣方法（如 Memtis）之間存在複雜的取捨：  
1. 頁面錯誤追蹤：
 * 能有效捕捉訪問的最近性（Recency）。
 * 可能導致較高的成本，且位於程式執行的關鍵路徑。
2. 硬體採樣方法：
 * 不在程式執行的關鍵路徑，能捕捉訪問頻率（Frequency）。
 * 對工作負載變化的響應不夠靈敏，準確性依賴於採樣率。

***NOMAD 的優勢與未來方向***  
NOMAD 是一種基於頁面錯誤的遷移方法，實現了非同步處理並移出關鍵路徑。未來的研究可考慮將 NOMAD 與基於硬體的訪問頻率追蹤方法（如 Memtis）結合，以加強當前的遷移策略。















































































































































































































































































































































































































































































































































































